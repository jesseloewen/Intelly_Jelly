<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Intelly Jelly</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üçá Intelly Jelly</h1>
            <p class="subtitle">Settings & Configuration</p>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/settings" class="active">Settings</a>
            </nav>
        </header>

        <div class="settings-container">
            <form id="settings-form" onsubmit="saveSettings(event)">
                
                <section class="settings-section">
                    <h2>üìÅ Directory Paths</h2>
                    
                    <div class="form-group">
                        <label for="downloading-path">Downloading Path:</label>
                        <input type="text" id="downloading-path" name="DOWNLOADING_PATH" required>
                        <small>Directory to monitor for new downloads</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="completed-path">Completed Path:</label>
                        <input type="text" id="completed-path" name="COMPLETED_PATH" required>
                        <small>Directory where completed downloads appear</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="library-path">Library Path:</label>
                        <input type="text" id="library-path" name="LIBRARY_PATH" required>
                        <small>Destination directory for organized files</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructions-path">Instructions File Path:</label>
                        <input type="text" id="instructions-path" name="INSTRUCTIONS_FILE_PATH" required>
                        <small>Path to AI instructions file</small>
                    </div>
                </section>

                <section class="settings-section">
                    <h2>‚è±Ô∏è Processing Settings</h2>
                    
                    <div class="form-group">
                        <label for="debounce-seconds">Debounce Seconds:</label>
                        <input type="number" id="debounce-seconds" name="DEBOUNCE_SECONDS" min="1" max="60" required>
                        <small>Wait time before processing new files (1-60 seconds)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="batch-size">AI Batch Size:</label>
                        <input type="number" id="batch-size" name="AI_BATCH_SIZE" min="1" max="100" required>
                        <small>Number of files to process in each batch</small>
                    </div>
                </section>

                <section class="settings-section">
                    <h2>ü§ñ AI Configuration</h2>
                    
                    <div class="form-group">
                        <label for="ai-provider">AI Provider:</label>
                        <select id="ai-provider" name="AI_PROVIDER" onchange="loadModels()" required>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="openai">OpenAI</option>
                            <option value="google">Google Gemini</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="ollama-url-group">
                        <label for="ollama-url">Ollama API URL:</label>
                        <input type="text" id="ollama-url" name="OLLAMA_API_URL">
                        <small>Default: http://localhost:11434</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-model">AI Model:</label>
                        <select id="ai-model" name="AI_MODEL" required>
                            <option value="">Loading models...</option>
                        </select>
                        <button type="button" onclick="loadModels()" class="btn btn-small">üîÑ Refresh Models</button>
                    </div>
                </section>

                <section class="settings-section">
                    <h2>‚öôÔ∏è Advanced Options</h2>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="dry-run" name="DRY_RUN_MODE">
                            Dry Run Mode
                        </label>
                        <small>Test AI without making actual API calls</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="web-search" name="ENABLE_WEB_SEARCH">
                            Enable Web Search
                        </label>
                        <small>Allow AI to search web for metadata (future feature)</small>
                    </div>
                </section>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                    <button type="button" onclick="loadConfig()" class="btn">üîÑ Reload</button>
                </div>
                
                <div id="save-message" class="message"></div>
            </form>

            <section class="settings-section">
                <h2>üîê API Keys</h2>
                <p class="info-box">
                    API keys are stored securely in the <code>.env</code> file and cannot be viewed or edited through this interface.
                    To set API keys, edit the <code>.env</code> file directly in the application directory.
                </p>
                <p class="info-box">
                    <strong>Required keys:</strong><br>
                    ‚Ä¢ <code>OPENAI_API_KEY</code> - For OpenAI GPT models<br>
                    ‚Ä¢ <code>GOOGLE_API_KEY</code> - For Google Gemini models<br>
                    ‚Ä¢ Ollama requires no API key (runs locally)
                </p>
            </section>
        </div>
    </div>

    <script>
        // Load current configuration on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Populate form fields
                document.getElementById('downloading-path').value = config.DOWNLOADING_PATH || '';
                document.getElementById('completed-path').value = config.COMPLETED_PATH || '';
                document.getElementById('library-path').value = config.LIBRARY_PATH || '';
                document.getElementById('instructions-path').value = config.INSTRUCTIONS_FILE_PATH || '';
                document.getElementById('debounce-seconds').value = config.DEBOUNCE_SECONDS || 5;
                document.getElementById('batch-size').value = config.AI_BATCH_SIZE || 10;
                document.getElementById('ai-provider').value = config.AI_PROVIDER || 'ollama';
                document.getElementById('ollama-url').value = config.OLLAMA_API_URL || 'http://localhost:11434';
                document.getElementById('dry-run').checked = config.DRY_RUN_MODE || false;
                document.getElementById('web-search').checked = config.ENABLE_WEB_SEARCH || false;
                
                // Update Ollama URL visibility
                toggleOllamaURL();
                
                // Load available models
                await loadModels();
                
                // Set current model after loading
                document.getElementById('ai-model').value = config.AI_MODEL || '';
                
            } catch (error) {
                showMessage('Error loading configuration: ' + error.message, 'error');
            }
        }

        async function loadModels() {
            const modelSelect = document.getElementById('ai-model');
            const currentValue = modelSelect.value;
            
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            modelSelect.disabled = true;
            
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                
                if (data.models && data.models.length > 0) {
                    modelSelect.innerHTML = '';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // Restore previous value if it exists
                    if (currentValue && data.models.includes(currentValue)) {
                        modelSelect.value = currentValue;
                    }
                } else {
                    modelSelect.innerHTML = '<option value="">No models available</option>';
                }
            } catch (error) {
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
                console.error('Error loading models:', error);
            } finally {
                modelSelect.disabled = false;
            }
            
            toggleOllamaURL();
        }

        function toggleOllamaURL() {
            const provider = document.getElementById('ai-provider').value;
            const ollamaGroup = document.getElementById('ollama-url-group');
            ollamaGroup.style.display = provider === 'ollama' ? 'block' : 'none';
        }

        async function saveSettings(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                // Convert numbers
                if (key === 'DEBOUNCE_SECONDS' || key === 'AI_BATCH_SIZE') {
                    config[key] = parseInt(value);
                }
                // Convert booleans
                else if (key === 'DRY_RUN_MODE' || key === 'ENABLE_WEB_SEARCH') {
                    config[key] = value === 'on';
                }
                // Keep as string
                else {
                    config[key] = value;
                }
            }
            
            // Add unchecked checkboxes as false
            if (!config.DRY_RUN_MODE) config.DRY_RUN_MODE = false;
            if (!config.ENABLE_WEB_SEARCH) config.ENABLE_WEB_SEARCH = false;
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Configuration saved successfully!', 'success');
                } else {
                    showMessage('‚ùå Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error saving configuration: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('save-message');
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
